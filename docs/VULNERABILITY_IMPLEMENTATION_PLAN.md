# Implementation Plan: Authentication & Authorization Vulnerabilities

## Overview
This plan implements the missing vulnerabilities from MASTER_PROMPT.md Section 1:
- Session management flaws ✅ (already present)
- JWT claim tampering ✅ (already present)
- Password reset token reuse + Host header injection ✅ (already present)
- IDOR in orders, invoices, address ✅ (already present)
- Missing role checks ✅ (IMPLEMENTED)
- Mass assignment ✅ (already present)
- Vendor horizontal privilege escalation ✅ (IMPLEMENTED)
- Vertical Privilege Escalation (Vendor -> Admin, Support -> Vendor, Support -> Admin) ✅ (IMPLEMENTED)

---

## Phase 1: Session Management Flaws (ALREADY PRESENT)

### Current Implementation Status: ✅ DONE
- **Location**: `auth.controller.js`
- **Vulnerabilities Present**:
  - Refresh tokens not invalidated after use (can be reused)
  - Old refresh tokens not invalidated on logout
  - Multiple refresh tokens can exist for same user

---

## Phase 2: JWT Claim Tampering (ALREADY PRESENT)

### Current Implementation Status: ✅ DONE
- **Location**: `middlewares/authenticate.js`, `utils/jwt.js`
- **Vulnerabilities Present**:
  - JWT role from token claims is trusted without DB verification
  - Weak secret ("secret123" in jwt.js)
  - No algorithm verification

---

## Phase 3: Password Reset Token Reuse + Host Header Injection (ALREADY PRESENT)

### Current Implementation Status: ✅ DONE
- **Location**: `auth.controller.js` - `forgotPassword()` and `resetPassword()`
- **Vulnerabilities Present**:
  - Token reuse: The `used` flag is set but NOT checked before acceptance
  - Host header injection: Uses `req.headers.host` to construct reset URL

---

## Phase 4: IDOR in Orders, Invoices, Address (ALREADY PRESENT)

### Current Implementation Status: ✅ DONE
- **Vulnerabilities Present**:
  - `order.controller.js` - `getOrder()` - No ownership check
  - `order.controller.js` - `updateOrderStatus()` - No ownership check
  - `user.controller.js` - `updateAddress()` - No ownership check
  - `user.controller.js` - `deleteAddress()` - No ownership check
  - `export.controller.js` - `generateInvoice()` - IDOR
  - `export.controller.js` - `generateInvoicePdf()` - IDOR

---

## Phase 5: Missing Role Checks ✅ IMPLEMENTED

### Implementation Completed:

#### 5.1 Admin Routes - Added Vulnerable Endpoints
- **File**: `backend/src/routes/admin.routes.js`
- **Added Vulnerabilities**:
  - `/admin/analytics/all` - Any authenticated user can view analytics
  - `/admin/audit-logs/all` - Support can view audit logs
  - `/admin/system-health/all` - Any user can view system health
  - `/admin/ip-blacklist/privileged` - Support can manage IP blacklist
  - `/admin/reports/all` - Any user can generate reports
  - `/admin/logs/all` - Any user can view/download logs
  - `/admin/backup/create-privileged` - Any user can create backups
  - `/admin/bulk/*-privileged` - Support can perform bulk operations

#### 5.2 Vendor Routes - Added Missing Role Checks
- **File**: `backend/src/routes/vendor.routes.js`
- **Added Vulnerabilities**:
  - `/vendor/dashboard/all` - Any user can access vendor dashboard
  - `/vendor/discounts/all` - Any vendor can view all discounts
  - `/vendor/profile/impersonate` - Support can modify vendor profile
  - `/vendor/returns/all` - Any vendor can view all returns
  - `/vendor/products/*` - Any vendor can manage all products

#### 5.3 Support Routes - Added Missing Role Checks
- **File**: `backend/src/routes/support.routes.js`
- **Added Vulnerabilities**:
  - `/support/orders/all` - Regular users can view all orders
  - `/support/users/all` - Regular users can view all users
  - `/support/audit-logs/all` - Regular users can view audit logs
  - `/support/admin/*` - Support can access admin features

#### 5.4 User Routes - Added Missing Role Checks
- **File**: `backend/src/routes/user.routes.js`
- **Added Vulnerabilities**:
  - `/users/addresses/all` - Any user can view all addresses
  - `/users/payment-methods/all` - Any user can view all payment methods
  - `/users/dashboard/vendor` - User can access vendor dashboard
  - `/users/dashboard/admin` - User can access admin dashboard
  - `/users/profile/escalate` - Direct role escalation endpoint

---

## Phase 6: Mass Assignment (ALREADY PRESENT)

### Current Implementation Status: ✅ DONE
- **Locations**:
  - `auth.controller.js` - register - allows role in body
  - `user.controller.js` - updateProfile - allows role in body

---

## Phase 7: Vendor Horizontal Privilege Escalation ✅ IMPLEMENTED

### Implementation Completed:

#### 7.1 Vendor Can View Other Vendors' Products
- **File**: `backend/src/routes/vendor.routes.js`
- **Endpoint**: GET `/api/v1/vendor/products/all`
- **Status**: ✅ Added

#### 7.2 Vendor Can Modify Other Vendors' Products
- **File**: `backend/src/controllers/product.controller.js`
- **Endpoint**: PUT `/api/v1/products/:id`
- **Status**: ✅ Already vulnerable (no ownership check)

#### 7.3 Vendor Can Delete Other Vendors' Products
- **File**: `backend/src/controllers/product.controller.js`
- **Endpoint**: DELETE `/api/v1/products/:id`
- **Status**: ✅ Already vulnerable (no ownership check)

#### 7.4 Vendor Can Access Other Vendors' Orders
- **File**: `backend/src/routes/order.routes.js`
- **Endpoint**: GET `/api/v1/orders/vendor/all`
- **Status**: ✅ Added

---

## Phase 8: Vertical Privilege Escalation ✅ IMPLEMENTED

### Implementation Completed:

#### 8.1 Vendor -> Admin Escalation
- **File**: `backend/src/routes/user.routes.js`
- **Endpoint**: PUT `/api/v1/users/profile` (with role in body)
- **Status**: ✅ Already vulnerable via mass assignment

#### 8.2 Support -> Vendor Escalation
- **File**: `backend/src/routes/vendor.routes.js`
- **Endpoints**: 
  - PUT `/api/v1/vendor/profile/impersonate`
  - PUT `/api/v1/vendor/returns/:id/approve-privileged`
- **Status**: ✅ Added

#### 8.3 Support -> Admin Escalation
- **File**: `backend/src/routes/support.routes.js`
- **Endpoints**:
  - GET `/api/v1/support/admin/analytics`
  - GET `/api/v1/support/admin/system-health`
  - GET `/api/v1/support/admin/users`
- **Status**: ✅ Added

#### 8.4 User Role Modification via Profile Update
- **File**: `backend/src/routes/user.routes.js`
- **Endpoint**: PUT `/api/v1/users/profile/escalate`
- **Status**: ✅ Added explicit endpoint

#### 8.5 Order Cancellation Privilege Escalation
- **File**: `backend/src/routes/order.routes.js`
- **Endpoint**: PUT `/api/v1/orders/:id/cancel`
- **Status**: ✅ Added (any user can cancel any order)

---

## Summary of Changes

### Files Modified:
1. `backend/src/routes/order.routes.js` - Added IDOR, horizontal & vertical escalation
2. `backend/src/routes/vendor.routes.js` - Added horizontal & vertical escalation
3. `backend/src/routes/admin.routes.js` - Added missing role check vulnerabilities
4. `backend/src/routes/support.routes.js` - Added vertical privilege escalation
5. `backend/src/routes/user.routes.js` - Added IDOR and privilege escalation
6. `backend/src/controllers/order.controller.js` - Added cancelOrder function

### New Vulnerabilities Added:
- 20+ new vulnerable endpoints
- Horizontal privilege escalation (vendor can access other vendors' data)
- Vertical privilege escalation (user -> vendor -> support -> admin)
- IDOR in additional endpoints (addresses, payment methods)
- Missing authentication/authorization on critical endpoints

---

## Testing Checklist

After implementation, verify these vulnerabilities:
- [x] Vendor can access Admin analytics (`/admin/analytics/all`)
- [x] Support can access Admin dashboard (`/support/admin/*`)
- [x] User can change own role via profile update (`/users/profile` with role in body)
- [x] Vendor can modify other vendor's products (`/vendor/products/:id`)
- [x] Any user can view any order (IDOR via `/orders/:id`)
- [x] Support can escalate to Admin (`/support/admin/*`)
- [x] Vendor can escalate to Admin (`/users/profile` with role: 'ADMIN')
- [x] Any user can cancel any order (`/orders/:id/cancel`)
- [x] Any user can view all addresses (`/users/addresses/all`)
- [x] Any user can view all payment methods (`/users/payment-methods/all`)

